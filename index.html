<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODI | Torre de Control V9.1</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg-color: #0d1117; --panel-bg: #161b22; --text-main: #c9d1d9; --accent-green: #238636; --accent-red: #da3633; --accent-blue: #58a6ff; --border: #30363d; --terminal-font: 'Courier New', Courier, monospace; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; margin: 0; padding: 20px; display: grid; grid-template-rows: auto auto 1fr auto; height: 100vh; box-sizing: border-box; gap: 20px; }
        
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; }
        .status-badge { background: var(--panel-bg); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border); font-size: 0.8rem; display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .status-badge.alert { border-color: #ffff00; box-shadow: 0 0 10px rgba(255, 255, 0, 0.2); }
        .dot { width: 10px; height: 10px; background: #666; border-radius: 50%; }
        .dot.active { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .dot.thinking { background: #ffff00; animation: pulse 1s infinite; }
        .dot.waiting { background: #ffaa00; animation: blink 0.5s infinite; }

        /* ACTION CENTER (NUEVO V9.1) */
        #action-center {
            background: rgba(30, 30, 40, 0.9);
            border: 1px solid var(--accent-blue);
            padding: 15px;
            border-radius: 8px;
            display: none; /* Oculto por defecto */
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }
        #action-text { font-weight: bold; color: white; font-size: 1.1rem; }
        .action-buttons { display: flex; gap: 10px; }
        .btn-confirm { background: var(--accent-green); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-cancel { background: var(--accent-red); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-confirm:hover, .btn-cancel:hover { opacity: 0.9; transform: scale(1.02); }

        main { display: grid; grid-template-columns: 350px 1fr; gap: 20px; overflow: hidden; }
        .panel { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 0.9rem; text-transform: uppercase; color: #8b949e; margin-bottom: 10px; font-weight: bold; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        #visual-container { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; border-radius: 4px; position: relative; }
        #visual-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .inventory-list { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: #8b949e; padding: 8px; border-bottom: 1px solid var(--border); }
        td { padding: 8px; border-bottom: 1px solid #21262d; }
        
        #logs-panel { grid-column: 1 / -1; height: 150px; background: #000; font-family: var(--terminal-font); font-size: 0.85rem; overflow-y: auto; padding: 10px; border: 1px solid var(--border); }
        .log-entry { margin-bottom: 4px; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        button#btn-mic { background: #333; color: #ccc; border: 1px solid #555; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        button#btn-mic:hover { background: #444; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes blink { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <header>
        <h1>ODI <span style="font-weight:normal; font-size:0.8em; color:#888;">// DASHBOARD V9.1</span></h1>
        <div class="status-badge" id="status-badge">
            <div class="dot" id="status-dot"></div>
            <span id="status-text">OFFLINE</span>
        </div>
    </header>

    <div id="action-center">
        <div id="action-text">‚ö†Ô∏è Acci√≥n requerida...</div>
        <div class="action-buttons">
            <button class="btn-cancel" onclick="sendGuiAction('cancel')">CANCELAR</button>
            <button class="btn-confirm" onclick="sendGuiAction('confirm')">AUTORIZAR</button>
        </div>
    </div>

    <main>
        <div class="panel">
            <div class="panel-title">Visual Cortex</div>
            <div id="visual-container"><span style="color:#333;">Esperando...</span></div>
        </div>
        <div class="panel">
            <div class="panel-title">Inventario</div>
            <div class="inventory-list">
                <table id="inventory-table">
                    <thead><tr><th>Producto</th><th>Precio</th><th>Estado</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="logs-panel"><div class="log-entry">> SISTEMA LISTO.</div></div>
    <div class="controls"><button id="btn-mic">üéôÔ∏è HABLAR</button></div>

    <script>
        const socket = io();
        const ui = {
            dot: document.getElementById('status-dot'),
            text: document.getElementById('status-text'),
            badge: document.getElementById('status-badge'),
            actionCenter: document.getElementById('action-center'),
            actionText: document.getElementById('action-text'),
            logs: document.getElementById('logs-panel'),
            visual: document.getElementById('visual-container'),
            inv: document.getElementById('inventory-table').querySelector('tbody'),
            mic: document.getElementById('btn-mic')
        };

        function addLog(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = `> ${msg}`;
            ui.logs.appendChild(div);
            ui.logs.scrollTop = ui.logs.scrollHeight;
        }

        function setStatus(mode, text) {
            ui.dot.className = `dot ${mode}`;
            ui.text.innerText = text;
            if (mode === 'waiting') ui.badge.classList.add('alert');
            else ui.badge.classList.remove('alert');
        }

        window.sendGuiAction = (action) => {
            socket.emit('gui_action', { action }); 
            ui.actionCenter.style.display = 'none'; 
            setStatus('active', 'ONLINE');
        };

        socket.on('connect', () => setStatus('active', 'ONLINE'));
        socket.on('disconnect', () => setStatus('', 'OFFLINE'));

        socket.on('ask_confirmation', (data) => {
            ui.actionText.innerText = `‚ö†Ô∏è ${data.message}`;
            ui.actionCenter.style.display = 'flex'; 
            setStatus('waiting', 'ESPERANDO AUTORIZACI√ìN');
            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{}); 
        });

        // üî• AJUSTE 2: LIMPIEZA AUTOM√ÅTICA
        socket.on('clear_confirmation', () => {
            ui.actionCenter.style.display = 'none';
            setStatus('active', 'ONLINE');
        });

        socket.on('inventory_update', (products) => {
            ui.inv.innerHTML = "";
            if (products.length === 0) {
                 ui.inv.innerHTML = "<tr><td colspan='3' style='text-align:center; color:#444;'>Inventario Vac√≠o</td></tr>";
                 return;
            }
            products.forEach(p => {
                const statusColor = p.status === 'local' ? '#888' : '#238636';
                ui.inv.innerHTML += `<tr><td>${p.name}</td><td style="color:#238636">${p.price}</td><td style="color:${statusColor}">${p.status}</td></tr>`;
            });
        });

        socket.on('log_update', (data) => {
            if (data.action.includes("CREATE") || data.action.includes("DELETE") || data.action.includes("SHOPIFY") || data.action.includes("ERROR")) {
                addLog(`[SYNC] ${data.action}: ${data.details}`);
            }
        });

        socket.on('response', (data) => {
            if (data.audio) new Audio(data.audio).play();
            addLog(`ODI: ${data.text}`);
            if (data.image) ui.visual.innerHTML = `<img src="${data.image}">`;
        });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const r = new SpeechRecognition();
            r.lang = 'es-ES';
            r.continuous = false;
            ui.mic.onclick = () => { r.start(); setStatus('thinking', 'ESCUCHANDO...'); };
            r.onresult = (e) => {
                const text = e.results[0][0].transcript;
                addLog(`T√ö: ${text}`);
                socket.emit('message', { text });
            };
            r.onend = () => { if(ui.actionCenter.style.display === 'none') setStatus('active', 'ONLINE'); };
        }
    </script>
</body>
</html>